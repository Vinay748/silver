<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Form Submitted</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #eaf6ff;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    .confirmation-box {
      background-color: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
      max-width: 500px;
      width: 90%;
    }

    .confirmation-box h2 {
      color: #0078D7;
      margin-bottom: 20px;
    }

    .confirmation-box p {
      font-size: 16px;
      color: #333;
      margin: 8px 0;
    }

    .confirmation-box .error {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }

    .confirmation-box .success {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
    }

    .confirmation-box .loading {
      color: #0078D7;
      font-style: italic;
    }

    .btn {
      background-color: #0078D7;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
      transition: background-color 0.3s ease;
    }

    .btn:hover {
      background-color: #005fa3;
    }

    .btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      margin: 10px 0;
      padding: 8px;
      background-color: #f8f9fa;
      border-radius: 4px;
    }

    .detail-label {
      font-weight: bold;
      color: #495057;
    }

    .detail-value {
      color: #212529;
    }

    .form-id-highlight {
      font-size: 18px;
      font-weight: bold;
      color: #0078D7;
      background-color: #e3f2fd;
      padding: 10px;
      border-radius: 6px;
      margin: 15px 0;
    }
  </style>
</head>

<body>
  <div class="confirmation-box">
    <h2>Form Submitted Successfully</h2>
    <div id="confirmationDetails">
      <p class="loading">Loading confirmation details...</p>
    </div>
    <button class="btn" id="dashboardBtn" onclick="window.location.href='/dashboard.html'">Go to Dashboard</button>
  </div>

  <script>
    // Enhanced confirmation loading with better error handling
    async function loadConfirmationDetails() {
      try {
        const response = await fetch('/api/employee/confirmation', {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error(`Server error: ${response.status} ${response.statusText}`);
        }

        const result = await response.json();

        if (!result.success || !result.data) {
          throw new Error(result.message || 'Failed to load confirmation details');
        }

        const data = result.data;

        // Format submission date
        const submissionDate = data.submissionDate ?
          new Date(data.submissionDate).toLocaleString() : 'N/A';

        // Create success display
        document.getElementById('confirmationDetails').innerHTML = `
                    <div class="success">
                        <p><strong>Your application has been submitted successfully!</strong></p>
                    </div>
                    
                    <div class="form-id-highlight">
                        Form ID: ${data.formId}
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span class="detail-value">${data.name || data.employeeName || 'N/A'}</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Employee ID:</span>
                        <span class="detail-value">${data.employeeId}</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">${data.department}</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">No Dues Type:</span>
                        <span class="detail-value">${data.noDuesType}</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value">${data.email}</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Submitted At:</span>
                        <span class="detail-value">${submissionDate}</span>
                    </div>

                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value" style="color: #28a745; font-weight: bold;">${data.status || 'Pending'}</span>
                    </div>

                    <p style="margin-top: 20px; color: #6c757d; font-size: 14px;">
                        <strong>Next Steps:</strong> Your application will be reviewed by the IT department. 
                        You can track the progress from your dashboard.
                    </p>
                `;

      } catch (error) {

        document.getElementById('confirmationDetails').innerHTML = `
                    <div class="error">
                        <p><strong>Error loading confirmation details</strong></p>
                        <p>${error.message}</p>
                        <p style="font-size: 14px; margin-top: 10px;">
                            Please check your session or contact support if this problem persists.
                        </p>
                    </div>
                `;

        // Disable dashboard button on error
        const dashboardBtn = document.getElementById('dashboardBtn');
        dashboardBtn.textContent = 'Session Error - Login Again';
        dashboardBtn.onclick = () => window.location.href = '/';
      }
    }

    // Check session and load confirmation details
    async function initializePage() {
      try {
        // First check if user session is valid
        const sessionResponse = await fetch('/api/auth/check-session', {
          credentials: 'include'
        });

        if (!sessionResponse.ok) {
          throw new Error('Session expired');
        }

        const sessionData = await sessionResponse.json();

        if (sessionData.role !== 'employee') {
          throw new Error('Invalid user role');
        }

        // Load confirmation details
        await loadConfirmationDetails();

      } catch (error) {

        document.getElementById('confirmationDetails').innerHTML = `
                    <div class="error">
                        <p><strong>Session Expired</strong></p>
                        <p>Please login again to view confirmation details.</p>
                    </div>
                `;

        const dashboardBtn = document.getElementById('dashboardBtn');
        dashboardBtn.textContent = 'Login Again';
        dashboardBtn.onclick = () => window.location.href = '/';
      }
    }

    // Initialize page when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializePage);

    // Add keyboard shortcut to go to dashboard
    document.addEventListener('keydown', function (event) {
      if (event.key === 'Enter' || event.key === 'Escape') {
        window.location.href = '/dashboard.html';
      }
    });
  </script>
</body>

</html>